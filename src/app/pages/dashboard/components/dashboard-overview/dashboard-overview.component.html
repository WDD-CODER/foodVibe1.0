<div class="dashboard-overview" dir="rtl">
  <header class="dashboard-header">
    <h1 class="page-title">{{ 'dashboard' | translatePipe }}</h1>
    <div class="quick-actions">
      <button type="button" class="qa-btn primary" (click)="goToAddProduct()">
        <lucide-icon name="plus-circle" [size]="18"></lucide-icon>
        <span>{{ 'add_product' | translatePipe }}</span>
      </button>
      <button type="button" class="qa-btn" (click)="goToRecipeBuilder('preparation')">
        <lucide-icon name="file-plus" [size]="18"></lucide-icon>
        <span>{{ 'new_recipe' | translatePipe }}</span>
      </button>
      <button type="button" class="qa-btn" (click)="goToRecipeBuilder('dish')">
        <lucide-icon name="utensils" [size]="18"></lucide-icon>
        <span>{{ 'new_dish' | translatePipe }}</span>
      </button>
    </div>
  </header>

  <main class="dashboard-main">
    <section class="kpi-grid">
      <article class="kpi-card">
        <h2 class="kpi-label">{{ 'total_products' | translatePipe }}</h2>
        <p class="kpi-value">{{ totalProducts_() }}</p>
        <div class="kpi-actions">
          <button type="button" class="link-btn" (click)="goToInventory()">
            {{ 'view_inventory' | translatePipe }}
          </button>
          <button type="button" class="link-btn" (click)="goToAddProduct()">
            {{ 'add_product' | translatePipe }}
          </button>
        </div>
      </article>

      <article class="kpi-card">
        <h2 class="kpi-label">{{ 'total_recipes' | translatePipe }}</h2>
        <p class="kpi-value">{{ totalRecipes_() }}</p>
        <button type="button" class="link-btn" (click)="goToRecipeBook()">
          {{ 'view_recipes' | translatePipe }}
        </button>
      </article>

      <article class="kpi-card warning">
        <h2 class="kpi-label">{{ 'low_stock' | translatePipe }}</h2>
        <p class="kpi-value">{{ lowStockCount_() }}</p>
      </article>

      <article class="kpi-card info">
        <h2 class="kpi-label">{{ 'unapproved_recipes' | translatePipe }}</h2>
        <p class="kpi-value">{{ unapprovedCount_() }}</p>
      </article>
    </section>

    <section class="activity-section">
      <header class="section-header">
        <h2>{{ 'recent_activity' | translatePipe }}</h2>
      </header>

      <div class="activity-list" *ngIf="getRecentActivity().length; else noActivity">
        <div class="activity-item" *ngFor="let item of getRecentActivity(); trackBy: trackByActivityId">
          <span class="entity-type-tag" [attr.data-entity]="item.entityType">
            {{ (item.entityType === 'product'
              ? 'product'
              : item.entityType === 'dish'
                ? 'dish'
                : 'preparation') | translatePipe }}
          </span>

          <span class="activity-name">
            {{ item.entityName }}
          </span>

          <div class="activity-changes">
            <button
              type="button"
              class="change-tag"
              *ngFor="let change of item.changes || []"
              (click)="toggleChangePopover(item.id, change.field, $event)"
            >
              {{ change.label | translatePipe }}
            </button>
          </div>

          <span class="activity-type" [attr.data-action]="item.action">
            {{ ('activity_' + item.action) | translatePipe }}
          </span>
        </div>
      </div>

      <ng-template #noActivity>
        <p class="empty-copy">
          {{ 'no_recent_activity' | translatePipe }}
        </p>
      </ng-template>
    </section>
  </main>

  <!-- Fixed popover above all content, positioned under the clicked tag; no backdrop -->
  <div
    class="change-popover-fixed"
    *ngIf="openChange_() as open"
    [style.top.px]="open.top"
    [style.left.px]="open.left"
    (clickOutside)="closeChangePopoverOnOutsideClick($event)"
  >
    <ng-container *ngIf="getOpenActivity() as activity" >
      <div *ngIf="getChange(activity, open.field) as c" class="change-popover">
        <!-- <span class="change-label">{{ c.label | translatePipe }}</span> -->
        <span class="change-from">{{ formatChangeValue(c.from) }}</span>
        <span class="change-arrow">‚Üê</span>
        <span class="change-to">{{ formatChangeValue(c.to) }}</span>
      </div>
    </ng-container>
  </div>
</div>
