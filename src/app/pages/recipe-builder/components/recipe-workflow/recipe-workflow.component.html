<div class="workflow-container shadow-sm" dir="rtl" [formGroup]="$any(workflowFormArray().parent)">
  
  @if (type() === 'preparation') {
    <div class="workflow-grid" formArrayName="workflow_items">
      <div class="grid-header">
        <div class="col-id text-center">#</div>
        <div class="col-instruction">{{ 'instruction' | translatePipe }}</div>
        <div class="col-timer text-center">{{ 'labor_time_minutes' | translatePipe }}</div>
        <div class="col-actions"></div>
      </div>

      <div class="grid-body">
        @for (group of workflowGroups_(); track group; let i = $index) {
          <div [formGroupName]="i" class="grid-row">
            <div class="col-id">
              <span class="step-badge">{{ i + 1 }}</span>
            </div>

            <div class="col-instruction">
              <textarea
                #instructionField
                formControlName="instruction"
                class="workflow-textarea"
                SelectOnFocus
                placeholder="{{ 'instruction_placeholder' | translatePipe }}"
                (keydown.enter)="onInstructionEnter($event)"></textarea>
            </div>

            <div class="col-timer">
              <div class="timer-counter">
                <lucide-icon name="timer" class="h-4 w-4 text-slate-400"></lucide-icon>
                <button
                  type="button"
                  class="counter-btn minus"
                  [disabled]="(group.get('labor_time')?.value ?? 0) <= 0"
                  (click)="decrementLaborTime(group)"
                  tabindex="-1"
                >
                  <lucide-icon name="minus" class="h-4 w-4"></lucide-icon>
                </button>
                @if (editingLaborTimeIndex_() === i) {
                  <input
                    #laborTimeInput
                    type="number"
                    formControlName="labor_time"
                    class="timer-field"
                    min="0"
                    SelectOnFocus
                    (blur)="exitLaborTimeEdit(group)"
                    (keydown.enter)="exitLaborTimeEdit(group); $event.preventDefault()"
                    (keydown.arrowDown)="onLaborTimeKeydown($event, group)"
                    (keydown.arrowUp)="onLaborTimeKeydown($event, group)"
                  />
                } @else {
                  <span
                    class="timer-value"
                    (click)="enterLaborTimeEdit(i)"
                    (focus)="enterLaborTimeEdit(i)"
                    tabindex="0"
                    role="button"
                  >{{ group.get('labor_time')?.value ?? 0 }}</span>
                }
                <button
                  type="button"
                  class="counter-btn plus"
                  (click)="incrementLaborTime(group)"
                  tabindex="-1"
                >
                  <lucide-icon name="plus" class="h-4 w-4"></lucide-icon>
                </button>
              </div>
            </div>

            <div class="col-actions place-self-center h-4">
              <button (click)="removeItem.emit(i)" class="delete-btn">
                <lucide-icon name="trash-2" class="h-4 w-4"></lucide-icon>
              </button>
            </div>
          </div>
        }
      </div>
      
      <button type="button" (click)="addItem.emit()" class="add-row-btn">
        <lucide-icon name="plus" class="ml-2 h-4 w-4"></lucide-icon>
        {{ 'add_prep_stage' | translatePipe }}
      </button>
    </div>
  }

  @else {
    <div class="prep-flat-grid" formArrayName="workflow_items">
      <div class="grid-header prep-grid-header">
        <div class="col-prep-name">{{ 'preparation' | translatePipe }}</div>
        <div class="col-prep-category sortable-header" (click)="sortByCategory.emit()">
          <span>{{ 'preparation_category' | translatePipe }}</span>
          <lucide-icon name="arrow-up-down" class="sort-icon" [size]="14"></lucide-icon>
        </div>
        <div class="col-prep-qty">{{ 'quantity' | translatePipe }}</div>
        <div class="col-prep-unit">{{ 'unit' | translatePipe }}</div>
        <div class="col-prep-actions"></div>
      </div>

      <div class="grid-body">
        @for (group of workflowGroups_(); track group; let i = $index) {
          <div [formGroupName]="i" class="prep-grid-row">
            <div class="col-prep-name">
              @if (!group.get('preparation_name')?.value) {
                <app-preparation-search
                  [selectedCategory]="group.get('category_name')?.value ?? ''"
                  [focusTrigger]="focusRowAt_()"
                  [rowIndex]="i"
                  (preparationSelected)="onPreparationSelected($event, group)"
                  (preparationAdded)="onPreparationSelected($event, group)"
                  (focusDone)="focusRowDone.emit()">
                </app-preparation-search>
              } @else {
                <div class="selected-item-display">
                  <span class="item-text">{{ group.get('preparation_name')?.value }}</span>
                  <button type="button" class="clear-btn" (click)="clearPreparation(group)">
                    <lucide-icon name="x" [size]="14"></lucide-icon>
                  </button>
                </div>
              }
            </div>

            <div class="col-prep-category">
              <select formControlName="category_name" class="grid-select category-select"
                (change)="onCategoryChange(group, $any($event.target).value)">
                <option value="">{{ 'choose_category' | translatePipe }}</option>
                @for (cat of getPreparationCategories(); track cat) {
                  <option [value]="cat">{{ cat | translatePipe }}</option>
                }
                <option value="__add_new__">{{ 'add_preparation_category' | translatePipe }}</option>
              </select>
            </div>

            <div class="col-prep-qty">
              <div class="quantity-controls">
                <button type="button" class="qty-btn minus"
                  [disabled]="(group.get('quantity')?.value ?? 0) <= 0"
                  (click)="decrementQuantity(group, i)"
                  tabindex="-1">
                  <lucide-icon name="minus" [size]="16"></lucide-icon>
                </button>
                <input type="number" SelectOnFocus formControlName="quantity"
                  class="grid-input qty-input" placeholder="1" />
                <button type="button" class="qty-btn plus" (click)="incrementQuantity(group, i)"
                  tabindex="-1">
                  <lucide-icon name="plus" [size]="16"></lucide-icon>
                </button>
              </div>
            </div>

            <div class="col-prep-unit">
              <select formControlName="unit" class="grid-select">
                @for (unit of getAllUnitKeys(); track unit) {
                  <option [value]="unit">{{ unit | translatePipe }}</option>
                }
              </select>
            </div>

            <div class="col-prep-actions">
              <button type="button" (click)="removeItem.emit(i)" class="delete-btn">
                <lucide-icon name="trash-2" class="h-4 w-4"></lucide-icon>
              </button>
            </div>
          </div>
        }
      </div>
      
      <button type="button" (click)="addItem.emit()" class="add-row-btn">
        <lucide-icon name="plus" class="ml-2 h-4 w-4"></lucide-icon>
        {{ 'add_preparation' | translatePipe }}
      </button>
    </div>
  }
</div>
