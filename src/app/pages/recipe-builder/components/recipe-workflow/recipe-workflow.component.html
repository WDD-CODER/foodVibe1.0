<div class="workflow-container shadow-sm" dir="rtl" [formGroup]="$any(workflowFormArray().parent)">
  
  @if (type() === 'preparation') {
    <div class="workflow-grid" formArrayName="workflow_items">
      <div class="grid-header">
        <div class="col-id text-center">#</div>
        <div class="col-instruction">תהליך / Instruction</div>
        <div class="col-timer text-center">זמן (דק')</div>
        <div class="col-actions"></div>
      </div>

      <div class="grid-body">
        @for (group of workflowGroups; track $index) {
          <div [formGroupName]="$index" class="grid-row">
            <div class="col-id">
              <span class="step-badge">{{ $index + 1 }}</span>
            </div>

            <div class="col-instruction">
              <textarea 
                formControlName="instruction" 
                class="workflow-textarea"
                placeholder="תאר את פעולת ההכנה..."></textarea>
            </div>

            <div class="col-timer">
              <div class="timer-input-group">
                <lucide-icon name="timer" class="h-4 w-4 text-slate-400"></lucide-icon>
                <input type="number" formControlName="labor_time" class="timer-field" />
              </div>
            </div>

            <div class="col-actions">
              <button (click)="removeItem.emit($index)" class="delete-btn">
                <lucide-icon name="trash-2" class="h-4 w-4"></lucide-icon>
              </button>
            </div>
          </div>
        }
      </div>
      
      <button type="button" (click)="addItem.emit()" class="add-row-btn">
        <lucide-icon name="plus" class="ml-2 h-4 w-4"></lucide-icon>
        הוסף שלב הכנה / Add Stage
      </button>
    </div>
  }

  @else {
    <div class="prep-flat-grid" formArrayName="workflow_items">
      <div class="grid-header prep-grid-header">
        <div class="col-prep-name">{{ 'preparation' | translatePipe }}</div>
        <div class="col-prep-category">{{ 'preparation_category' | translatePipe }}</div>
        <div class="col-prep-qty">{{ 'quantity' | translatePipe }}</div>
        <div class="col-prep-unit">{{ 'unit' | translatePipe }}</div>
        <div class="col-prep-actions"></div>
      </div>

      <div class="grid-body">
        @for (group of workflowGroups; track $index) {
          <div [formGroupName]="$index" class="prep-grid-row">
            <div class="col-prep-name">
              @if (!group.get('preparation_name')?.value) {
                <app-preparation-search
                  (preparationSelected)="onPreparationSelected($event, group)"
                  (preparationAdded)="onPreparationSelected($event, group)">
                </app-preparation-search>
              } @else {
                <div class="selected-item-display">
                  <span class="item-text">{{ group.get('preparation_name')?.value }}</span>
                  <button type="button" class="clear-btn" (click)="clearPreparation(group)">
                    <lucide-icon name="x" [size]="14"></lucide-icon>
                  </button>
                </div>
              }
            </div>

            <div class="col-prep-category">
              <span class="category-display">{{ group.get('category_name')?.value || '—' }}</span>
            </div>

            <div class="col-prep-qty">
              <div class="quantity-controls">
                <button type="button" class="qty-btn minus"
                  [disabled]="(group.get('quantity')?.value ?? 0) <= 0"
                  (click)="decrementQuantity(group, $index)">
                  <lucide-icon name="minus" [size]="16"></lucide-icon>
                </button>
                <input type="number" SelectOnFocus formControlName="quantity"
                  class="grid-input qty-input" placeholder="1" />
                <button type="button" class="qty-btn plus" (click)="incrementQuantity(group, $index)">
                  <lucide-icon name="plus" [size]="16"></lucide-icon>
                </button>
              </div>
            </div>

            <div class="col-prep-unit">
              <select formControlName="unit" class="grid-select">
                @for (unit of getAllUnitKeys(); track unit) {
                  <option [value]="unit">{{ unit | translatePipe }}</option>
                }
              </select>
            </div>

            <div class="col-prep-actions">
              <button type="button" (click)="removeItem.emit($index)" class="delete-btn">
                <lucide-icon name="trash-2" class="h-4 w-4"></lucide-icon>
              </button>
            </div>
          </div>
        }
      </div>
      
      <button type="button" (click)="addItem.emit()" class="add-row-btn">
        <lucide-icon name="plus" class="ml-2 h-4 w-4"></lucide-icon>
        {{ 'add_preparation' | translatePipe }}
      </button>
    </div>
  }
</div>
