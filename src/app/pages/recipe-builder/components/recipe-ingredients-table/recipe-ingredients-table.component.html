<div class="ingredients-container" dir="rtl">
  <div class="ingredients-grid-header">
    <div class="col-name">{{ 'ingredient' | translatePipe }}</div>
    <div class="col-quantity">{{ 'quantity' | translatePipe }}</div>
    <div class="col-unit">{{ 'unit' | translatePipe }}</div>
    <div class="col-percent">{{ 'percent' | translatePipe }}</div>
    <div class="col-cost">{{ 'cost' | translatePipe }}</div>
    <!-- <div class="col-actions">{{ 'actions' | translatePipe }}</div> -->
  </div>

  <div class="ingredients-grid-body">
    @for (group of ingredientGroups; track $index) {
    <div [formGroup]="group" class="ingredient-grid-row">

      <div class="col-name">
        @if (!group.get('referenceId')?.value) {
        <app-ingredient-search [rowIndex]="$index" [focusTrigger]="focusSearchAtRow"
          (itemSelected)="onItemSelected($event, group)" (focusDone)="focusSearchDone.emit()"
          (addNewRowRequested)="addIngredient.emit()"></app-ingredient-search>
        } @else {
        <div class="selected-item-display">
          <span class="item-text">{{ group.get('name_hebrew')?.value }}</span>
          <button type="button" class="clear-btn" (click)="clearIngredient(group)">
            <lucide-icon name="x" [size]="14"></lucide-icon>
          </button>
        </div>
        }
      </div>

      <div class="col-quantity">
        @if (group.get('referenceId')?.value) {
        <div class="quantity-controls">
          <button type="button" class="qty-btn minus" tabindex="-1"
            [disabled]="(group.get('amount_net')?.value ?? 0) <= 0"
            (click)="decrementAmount(group, $index)">
            <lucide-icon name="minus" [size]="16"></lucide-icon>
          </button>
          <input type="number" SelectOnFocus formControlName="amount_net" (input)="updateLineCalculations($index)"
            (keydown)="onQuantityKeydown($event, $index)" focusByRow [rowIndex]="$index" kind="qty"
            class="grid-input qty-input" placeholder="0" />
          <button type="button" class="qty-btn plus" tabindex="-1" (click)="incrementAmount(group, $index)">
            <lucide-icon name="plus" [size]="16"></lucide-icon>
          </button>
        </div>
        } @else {
        <span class="placeholder-dash">---</span>
        }
      </div>

      <div class="col-unit">
        @if (group.get('referenceId')?.value) {
        <select formControlName="unit" class="grid-select" (change)="updateLineCalculations($index)"
          (keydown)="onUnitKeydown($event, $index)" focusByRow [rowIndex]="$index" kind="unit">
          @for (unit of getAvailableUnits(group); track unit) {
          <option [value]="unit">{{ unit | translatePipe }}</option>
          }
        </select>
        } @else {
        <span class="placeholder-dash">---</span>
        }
      </div>

      <div class="col-percent">
        <span class="percent-value">{{ getPercentageDisplay(group) }}</span>
      </div>

      <div class="col-cost" [class.is-zero]="!group.get('total_cost')?.value">
        @if (!group.get('total_cost')?.value) {
        <span class="pending-text">{{ 'pending' | translatePipe }}</span>
        } @else {
        <span class="cost-value">â‚ª{{ group.get('total_cost')?.value | number:'1.2-2' }}</span>
        }
      </div>

      <div class="col-actions">
        <button type="button" (click)="removeIngredient.emit($index)" class="remove-btn">
          <lucide-icon name="trash-2" [size]="18"></lucide-icon>
        </button>
      </div>

    </div>
    }
  </div>
</div>