<div class="recipe-builder-container" dir="rtl">
  @if (historyViewMode_()) {
    <div class="history-view-banner">
      <span>{{ 'history_view_only_banner' | translatePipe }}</span>
      <button type="button" class="btn-back" (click)="navigateBackFromHistory()">
        {{ 'back_to_list' | translatePipe }}
      </button>
    </div>
  }
  <div class="builder-shell">

    <section class="builder-section">
      <app-recipe-header [form]="recipeForm_" [recipeType]="recipeType_()" [currentCost]="totalCost_()"
        [totalWeightG]="totalWeightG_()" [totalBrutoWeightG]="totalBrutoWeightG_()"
        [totalVolumeL]="totalVolumeL_()" [totalVolumeMl]="totalVolumeMl_()"
        [unconvertibleForWeight]="unconvertibleForWeight_()" [unconvertibleForVolume]="unconvertibleForVolume_()"
        [resetTrigger]="resetTrigger_()" [autoLabels]="liveAutoLabels_()" (openUnitCreator)="onOpenUnitCreator()"></app-recipe-header>
    </section>

    <section class="builder-section">
      <div class="section-card table-logic">
        <h2 class="section-title">{{ 'ingredients_index' | translatePipe }}</h2>

        <app-recipe-ingredients-table [ingredientsFormArray]="ingredientsArray"
          [portions]="portions_() ?? 1" [focusSearchAtRow]="focusIngredientSearchAtRow_()"
          (removeIngredient)="removeIngredient($event)" (addIngredient)="addNewIngredientRow()"
          (focusSearchDone)="onIngredientSearchFocusDone()">
        </app-recipe-ingredients-table>

        @if (!historyViewMode_()) {
          <button type="button" class="add-row-btn" (click)="addNewIngredientRow();$event.stopPropagation()">
            <div class="plus-icon-wrapper">
              <lucide-icon name="plus-circle" [size]="18"></lucide-icon>
            </div>
            <span class="btn-text">{{ 'add_row' | translatePipe }}</span>
          </button>
        }

      </div>
    </section>
    <section class="builder-section">
      <div class="section-card workflow-logic">
        <h2 class="section-title">
          {{ (recipeType_() === 'dish' ? 'prep_list_mise_en_place' : 'prep_workflow') | translatePipe }}
        </h2>
        <app-recipe-workflow [workflowFormArray]="workflowArray" [type]="recipeType_()" [resetTrigger]="resetTrigger_()"
          [focusRowAt]="focusWorkflowRowAt_()" (addItem)="addNewStep()"
          (removeItem)="deleteStep($event)" (sortByCategory)="sortPrepByCategory()" (focusRowDone)="focusWorkflowRowAt_.set(null)">
        </app-recipe-workflow>
      </div>
    </section>

    @if (!historyViewMode_()) {
      <section class="builder-section">
        <div class="section-card logistics-logic">
          <h2 class="section-title">{{ 'dish_logistics' | translatePipe }}</h2>
          <p class="section-desc">{{ 'dish_logistics_desc' | translatePipe }}</p>
          <div class="logistics-grid" [formGroup]="recipeForm_" (clickOutside)="logisticsToolDropdownOpen_.set(false)">
            <div class="logistics-chips-wrap" formGroupName="logistics">
              <div class="logistics-chips" formArrayName="baseline_">
                @for (ctrl of logisticsBaselineArray.controls; track $index; let i = $index) {
                  @let eqId = ctrl.get('equipment_id_')?.value;
                  @let qty = ctrl.get('quantity_')?.value;
                  <button type="button" class="logistics-chip"
                    (click)="removeBaselineRow(i)" [attr.aria-label]="'remove' | translatePipe">
                    <span class="logistics-chip-label">{{ getEquipmentNameById(eqId) }}</span>
                    <span class="logistics-chip-qty">Ã—{{ qty }}</span>
                  </button>
                }
              </div>
            </div>
            <div class="logistics-add-wrap">
              <div class="logistics-add-inner">
                <div class="logistics-tool-search-wrap">
                  <lucide-icon name="search" class="logistics-search-icon" [size]="18"></lucide-icon>
                  <input type="text" class="logistics-tool-search"
                    [value]="logisticsToolSearchQuery_()"
                    (input)="logisticsToolSearchQuery_.set($any($event.target).value); logisticsToolDropdownOpen_.set(true)"
                    (focus)="logisticsToolDropdownOpen_.set(true)"
                    [placeholder]="'search_tool_placeholder' | translatePipe" />
                </div>
                <input type="number" class="logistics-qty-input" min="1"
                  [value]="logisticsToolQuantity_()"
                  (input)="logisticsToolQuantity_.set($any($event.target).valueAsNumber || 1)" />
              </div>
              @if (logisticsToolDropdownOpen_()) {
                <app-scrollable-dropdown [maxHeight]="220" class="logistics-tool-dropdown">
                  <ul role="listbox">
                    <li role="option" class="logistics-tool-option logistics-tool-add-new"
                      (click)="openAddNewToolModal()">
                      <lucide-icon name="plus-circle" [size]="16"></lucide-icon>
                      <span>{{ 'add_new_tool' | translatePipe }}</span>
                    </li>
                    @for (eq of filteredLogisticsTools_(); track eq._id) {
                      <li role="option" class="logistics-tool-option"
                        (click)="addToolToBaseline(eq._id)">
                        {{ eq.name_hebrew }}
                      </li>
                    }
                  </ul>
                </app-scrollable-dropdown>
              }
            </div>
          </div>
        </div>
      </section>
    }

    @if (!historyViewMode_()) {
      <footer class="action-footer">
        <button class="main-submit-btn" [disabled]="isSaving_()" (click)="saveRecipe()">
          @if (isSaving_()) {
            <app-loader size="small" [inline]="true" />
          }
          {{ (isSaving_() ? 'saving' : (recipeType_() === 'dish' ? 'save_dish' : 'save_recipe')) | translatePipe }}
        </button>
      </footer>
    }

  </div>
</div>