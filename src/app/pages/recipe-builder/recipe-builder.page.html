<div class="recipe-builder-container" dir="rtl">
  @if (historyViewMode_()) {
    <div class="history-view-banner">
      <span>{{ 'history_view_only_banner' | translatePipe }}</span>
      <button type="button" class="btn-back" (click)="navigateBackFromHistory()">
        {{ 'back_to_list' | translatePipe }}
      </button>
    </div>
  }
  <div class="builder-shell">

    <section class="builder-section">
      <app-recipe-header [form]="recipeForm_" [currentCost]="totalCost_()"
        [totalWeightG]="totalWeightG_()" [totalBrutoWeightG]="totalBrutoWeightG_()"
        [totalVolumeL]="totalVolumeL_()" [totalVolumeMl]="totalVolumeMl_()"
        [unconvertibleForWeight]="unconvertibleForWeight_()" [unconvertibleForVolume]="unconvertibleForVolume_()"
        [resetTrigger]="resetTrigger_()" (openUnitCreator)="onOpenUnitCreator()"></app-recipe-header>
    </section>

    <section class="builder-section">
      <div class="section-card table-logic">
        <h2 class="section-title">{{ 'ingredients_index' | translatePipe }}</h2>

        <app-recipe-ingredients-table [ingredientsFormArray]="ingredientsArray"
          [portions]="portions_() ?? 1" [focusSearchAtRow]="focusIngredientSearchAtRow_()"
          (removeIngredient)="removeIngredient($event)" (addIngredient)="addNewIngredientRow()"
          (focusSearchDone)="onIngredientSearchFocusDone()">
        </app-recipe-ingredients-table>

        @if (!historyViewMode_()) {
          <button type="button" class="add-row-btn" (click)="addNewIngredientRow();$event.stopPropagation()">
            <div class="plus-icon-wrapper">
              <lucide-icon name="plus-circle" [size]="18"></lucide-icon>
            </div>
            <span class="btn-text">{{ 'add_row' | translatePipe }}</span>
          </button>
        }

      </div>
    </section>
    <section class="builder-section">
      <div class="section-card workflow-logic">
        <h2 class="section-title">
          {{ (recipeForm_.get('recipe_type')?.value === 'dish' ? 'prep_list_mise_en_place' : 'prep_workflow') | translatePipe }}
        </h2>
        <app-recipe-workflow [workflowFormArray]="workflowArray" [type]="recipeType_()" [resetTrigger]="resetTrigger_()" (addItem)="addNewStep()"
          (removeItem)="deleteStep($event)" (sortByCategory)="sortPrepByCategory()">
        </app-recipe-workflow>
      </div>
    </section>

    @if (!historyViewMode_()) {
      <footer class="action-footer">
        <button class="main-submit-btn" [disabled]="isSaving_()" (click)="saveRecipe()">
          {{ (isSaving_() ? 'saving' : (recipeForm_.get('recipe_type')?.value === 'dish' ? 'save_dish' : 'save_recipe')) | translatePipe }}
        </button>
      </footer>
    }

  </div>
</div>