<div class="recipe-builder-container" dir="rtl">
  @if (historyViewMode_()) {
    <div class="history-view-banner">
      <span>{{ 'history_view_only_banner' | translatePipe }}</span>
      <button type="button" class="btn-back" (click)="navigateBackFromHistory()">
        {{ 'back_to_list' | translatePipe }}
      </button>
    </div>
  }
  <div class="builder-shell">

    <section class="builder-section">
      <app-recipe-header [form]="recipeForm_" [recipeType]="recipeType_()" [currentCost]="totalCost_()"
        [totalWeightG]="totalWeightG_()" [totalBrutoWeightG]="totalBrutoWeightG_()"
        [totalVolumeL]="totalVolumeL_()" [totalVolumeMl]="totalVolumeMl_()"
        [unconvertibleForWeight]="unconvertibleForWeight_()" [unconvertibleForVolume]="unconvertibleForVolume_()"
        [resetTrigger]="resetTrigger_()" [autoLabels]="liveAutoLabels_()" (openUnitCreator)="onOpenUnitCreator()"></app-recipe-header>
    </section>

    <section class="builder-section">
      <div class="section-card table-logic">
        <h2 class="section-title">{{ 'ingredients_index' | translatePipe }}</h2>

        <app-recipe-ingredients-table [ingredientsFormArray]="ingredientsArray"
          [portions]="portions_() ?? 1" [focusSearchAtRow]="focusIngredientSearchAtRow_()"
          (removeIngredient)="removeIngredient($event)" (addIngredient)="addNewIngredientRow()"
          (focusSearchDone)="onIngredientSearchFocusDone()">
        </app-recipe-ingredients-table>

        @if (!historyViewMode_()) {
          <button type="button" class="add-row-btn" (click)="addNewIngredientRow();$event.stopPropagation()">
            <div class="plus-icon-wrapper">
              <lucide-icon name="plus-circle" [size]="18"></lucide-icon>
            </div>
            <span class="btn-text">{{ 'add_row' | translatePipe }}</span>
          </button>
        }

      </div>
    </section>
    <section class="builder-section">
      <div class="section-card workflow-logic">
        <h2 class="section-title">
          {{ (recipeForm_.get('recipe_type')?.value === 'dish' ? 'prep_list_mise_en_place' : 'prep_workflow') | translatePipe }}
        </h2>
        <app-recipe-workflow [workflowFormArray]="workflowArray" [type]="recipeType_()" [resetTrigger]="resetTrigger_()"
          [focusRowAt]="focusWorkflowRowAt_()" (addItem)="addNewStep()"
          (removeItem)="deleteStep($event)" (sortByCategory)="sortPrepByCategory()" (focusRowDone)="focusWorkflowRowAt_.set(null)">
        </app-recipe-workflow>
      </div>
    </section>

    @if (recipeForm_.get('recipe_type')?.value === 'dish' && !historyViewMode_()) {
      <section class="builder-section">
        <div class="section-card logistics-logic">
          <h2 class="section-title">{{ 'dish_logistics' | translatePipe }}</h2>
          <p class="section-desc">{{ 'dish_logistics_desc' | translatePipe }}</p>
          <div class="logistics-baseline" formGroupName="logistics">
            <div class="baseline-rows" formArrayName="baseline_">
              @for (ctrl of logisticsBaselineArray.controls; track $index; let i = $index) {
                <div class="baseline-row" [formGroupName]="i">
                  <select formControlName="equipment_id_">
                    <option value="">{{ 'choose_equipment' | translatePipe }}</option>
                    @for (eq of allEquipment_; track eq._id) {
                      <option [value]="eq._id">{{ eq.name_hebrew }}</option>
                    }
                  </select>
                  <input type="number" formControlName="quantity_" min="0" class="qty-input" />
                  <select formControlName="phase_">
                    <option value="prep">{{ 'phase_prep' | translatePipe }}</option>
                    <option value="service">{{ 'phase_service' | translatePipe }}</option>
                    <option value="both">{{ 'phase_both' | translatePipe }}</option>
                  </select>
                  <label class="critical-check">
                    <input type="checkbox" formControlName="is_critical_" />
                    {{ 'critical' | translatePipe }}
                  </label>
                  <button type="button" class="btn-remove" (click)="removeBaselineRow(i)" [attr.aria-label]="'remove' | translatePipe">
                    <lucide-icon name="trash-2" [size]="16"></lucide-icon>
                  </button>
                </div>
              }
            </div>
            <button type="button" class="add-row-btn" (click)="addBaselineRow()">
              <lucide-icon name="plus-circle" [size]="18"></lucide-icon>
              <span class="btn-text">{{ 'add_equipment_baseline' | translatePipe }}</span>
            </button>
          </div>
        </div>
      </section>
    }

    @if (!historyViewMode_()) {
      <footer class="action-footer">
        <button class="main-submit-btn" [disabled]="isSaving_()" (click)="saveRecipe()">
          @if (isSaving_()) {
            <app-loader size="small" [inline]="true" />
          }
          {{ (isSaving_() ? 'saving' : (recipeForm_.get('recipe_type')?.value === 'dish' ? 'save_dish' : 'save_recipe')) | translatePipe }}
        </button>
      </footer>
    }

  </div>
</div>