<div class="menu-editor-shell" dir="rtl">
  <!-- Toolbar (hidden in print) -->
  <div class="editor-toolbar no-print">
    <button type="button" class="toolbar-btn back" (click)="goBack()">
      <lucide-icon name="arrow-right" [size]="18"></lucide-icon>
      {{ 'menu_library' | translatePipe }}
    </button>
    <div class="toolbar-actions">
      <button type="button" class="toolbar-btn export" (click)="printMenu()">
        <lucide-icon name="printer" [size]="16"></lucide-icon>
        {{ 'menu_export_customer' | translatePipe }}
      </button>
      <button type="button" class="toolbar-btn save" (click)="save()" [disabled]="isSaving_()">
        @if (isSaving_()) {
          <app-loader size="small" [inline]="true" />
        }
        <lucide-icon name="save" [size]="16"></lucide-icon>
        {{ isSaving_() ? ('saving' | translatePipe) : ('menu_save' | translatePipe) }}
      </button>
    </div>
  </div>

  <!-- Paper in the middle of the screen -->
  <div class="paper-outer">
    <div class="paper" [formGroup]="form_">
      <div class="paper-inner">
    <div class="paper-ornament top"></div>
    
    <div class="meta-row">
      <input
        id="menu-focus-name_"
        type="text"
        class="meta-input menu-name-input"
        formControlName="name_"
        [attr.aria-label]="'menu_name_placeholder' | translatePipe"
        [placeholder]="'menu_name_placeholder' | translatePipe"
        (keydown)="onMetaKeydown('name_', $event)"
      />
    </div>

    <!-- Metadata column: title stays, value to the left (RTL: value on right) -->
    <div class="meta-column">
      <!-- Menu Name: h1-style input, no label -->

      <!-- Event Type: label + value/trigger; click opens dropdown with search + add new -->
      <div class="meta-row">
        <span class="meta-label">{{ 'menu_event_type' | translatePipe }}</span>
        <div class="meta-value-wrap">
          @if (eventTypeDropdownOpen_()) {
            <div class="event-type-dropdown">
              <input
                id="menu-focus-event_type_search"
                type="text"
                class="meta-input event-type-search"
                [ngModel]="eventTypeSearch_()"
                [ngModelOptions]="{ standalone: true }"
                (ngModelChange)="eventTypeSearch_.set($event)"
                [placeholder]="'search' | translatePipe"
                (keydown.escape)="closeEventTypeDropdown(); focusField('event_type_')"
                (keydown.tab)="closeEventTypeDropdown(); focusField('serving_type_'); $event.preventDefault()"
                (keydown.enter)="getFilteredEventTypes().length ? selectEventType(getFilteredEventTypes()[0]) : focusField('serving_type_'); $event.preventDefault()"
              />
              <app-scrollable-dropdown [maxHeight]="200">
                @for (t of getFilteredEventTypes(); track t) {
                  <button type="button" class="dropdown-item" (click)="selectEventType(t)">{{ t }}</button>
                }
                <button type="button" class="dropdown-item add-new" (click)="addNewEventType()">
                  + {{ 'add_new_category' | translatePipe }}
                </button>
              </app-scrollable-dropdown>
            </div>
          } @else {
            <button type="button" id="menu-focus-event_type_" class="meta-trigger"
              (click)="openEventTypeDropdown()"
              (keydown)="onMetaKeydown('event_type_', $event)">
              {{ form_.value.event_type_ || ('menu_event_type' | translatePipe) }}
            </button>
          }
        </div>
      </div>

      <!-- Serving Type (menu type from registry) -->
      <div class="meta-row" (keydown)="onMetaKeydown('serving_type_', $event)">
        <span class="meta-label">{{ 'menu_serving_style' | translatePipe }}</span>
        <app-custom-select
          triggerId="menu-focus-serving_type_"
          formControlName="serving_type_"
          [options]="servingTypeOptions_()"
          [placeholder]="'menu_serving_style'" />
      </div>

      <!-- Guest Count -->
      <div class="meta-row">
        <span class="meta-label">{{ 'menu_guests' | translatePipe }}</span>
        <input id="menu-focus-guest_count_" type="number" class="meta-input meta-number" formControlName="guest_count_" min="1"
          (keydown)="onMetaKeydown('guest_count_', $event)" />
      </div>

      <!-- Event Date -->
      <div class="meta-row">
        <span class="meta-label">{{ 'menu_set_date' | translatePipe }}</span>
        <input id="menu-focus-event_date_" type="date" class="meta-input meta-date" formControlName="event_date_"
          (keydown)="onMetaKeydown('event_date_', $event)" />
      </div>
    </div>

    <div class="paper-divider"></div>

    <!-- Sections: category looks like plain text; dropdown only on click -->
    <div class="sections-area" formArrayName="sections_">
      @for (section of sectionsArray.controls; track section.get('_id')?.value; let sectionIndex = $index) {
        <div class="menu-section" [formGroupName]="sectionIndex">
          @if (sectionIndex > 0) {
            <div class="section-ornament"></div>
          }

          <div class="section-header">
            @if (sectionSearchOpen_() === sectionIndex) {
              <div class="section-search-wrap" (clickOutside)="closeSectionSearch()">
                <input
                  type="text"
                  class="section-search-input"
                  [ngModel]="getSectionSearchQuery(sectionIndex)"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="setSectionSearchQuery(sectionIndex, $event)"
                  [placeholder]="'menu_search_category' | translatePipe"
                  (keydown.enter)="addNewSectionCategory(sectionIndex); closeSectionSearch()"
                  (keydown.escape)="closeSectionSearch()"
                />
                <app-scrollable-dropdown [maxHeight]="200">
                  @for (cat of getFilteredSectionCategories(sectionIndex); track cat) {
                    <button type="button" class="dropdown-item" (click)="selectSectionCategory(sectionIndex, cat)">
                      {{ cat | translatePipe }}
                    </button>
                  }
                  @if (getSectionSearchQuery(sectionIndex).trim()) {
                    <button type="button" class="dropdown-item add-new" (click)="addNewSectionCategory(sectionIndex)">
                      + {{ getSectionSearchQuery(sectionIndex) }}
                    </button>
                  }
                  <button type="button" class="dropdown-item add-new" (click)="openAddCategoryModal(sectionIndex)">
                    + {{ 'add_new_category' | translatePipe }}
                  </button>
                </app-scrollable-dropdown>
              </div>
            } @else {
              <button type="button" class="section-title-plain" (click)="openSectionSearch(sectionIndex)">
                {{ section.get('name_')?.value || ('menu_section_placeholder' | translatePipe) }}
              </button>
            }
            <button type="button" class="section-remove no-print" (click)="removeSection(sectionIndex)">
              <lucide-icon name="x" [size]="14"></lucide-icon>
            </button>
          </div>

          <div class="dish-list" formArrayName="items_">
            @for (item of getItemsArray(sectionIndex).controls; track $index; let itemIndex = $index) {
              <div class="dish-row" [formGroupName]="itemIndex">
                <div class="dish-name-cell">
                  @if (item.get('recipe_id_')?.value) {
                    <span class="dish-name">{{ getRecipeName(item.get('recipe_id_')?.value) }}</span>
                    <button type="button" class="dish-meta-toggle no-print"
                      [attr.aria-label]="isDishMetaExpanded(sectionIndex, itemIndex) ? ('hide_metadata' | translatePipe) : ('show_metadata' | translatePipe)"
                      (click)="toggleDishMeta(sectionIndex, itemIndex)">
                      <lucide-icon [name]="isDishMetaExpanded(sectionIndex, itemIndex) ? 'chevron-up' : 'chevron-down'" [size]="16"></lucide-icon>
                    </button>
                    <button type="button" class="dish-remove no-print" (click)="removeItem(sectionIndex, itemIndex)">
                      <lucide-icon name="x" [size]="14"></lucide-icon>
                    </button>
                  } @else {
                    <div class="dish-search-wrap">
                      <input type="text" class="dish-search-input"
                        [ngModel]="getDishSearchQuery(sectionIndex, itemIndex)"
                        [ngModelOptions]="{ standalone: true }"
                        (ngModelChange)="setDishSearchQuery(sectionIndex, itemIndex, $event)"
                        [placeholder]="'menu_search_dish' | translatePipe" />
                      @if (getDishSearchQuery(sectionIndex, itemIndex).trim()) {
                        <app-scrollable-dropdown [maxHeight]="200">
                          @for (recipe of getFilteredRecipes(sectionIndex, itemIndex); track recipe._id) {
                            <button type="button" class="dropdown-item" (click)="selectRecipe(sectionIndex, itemIndex, recipe)">
                              {{ recipe.name_hebrew }}
                            </button>
                          }
                          @if (getFilteredRecipes(sectionIndex, itemIndex).length === 0) {
                            <span class="dropdown-empty">{{ 'no_recipes_match' | translatePipe }}</span>
                          }
                        </app-scrollable-dropdown>
                      }
                    </div>
                  }
                </div>
                @if (item.get('recipe_id_')?.value && isDishMetaExpanded(sectionIndex, itemIndex)) {
                  <div class="dish-data">
                    @for (fieldKey of activeMenuTypeFields_(); track fieldKey) {
                      <div class="dish-field" (click)="!isEditingDishField(sectionIndex, itemIndex, fieldKey) && startEditDishField(sectionIndex, itemIndex, fieldKey)">
                        <span class="dish-field-label">{{ getDishFieldLabelKey(fieldKey) | translatePipe }}</span>
                        @if (isEditingDishField(sectionIndex, itemIndex, fieldKey)) {
                          <input [id]="'dish-' + sectionIndex + '-' + itemIndex + '-' + fieldKey"
                            type="number" [formControlName]="fieldKey" min="0" step="0.01"
                            class="dish-field-input-inline"
                            [style.width]="getInputWidth(item.get(fieldKey)?.value)"
                            (blur)="commitEditDishField()"
                            (keydown.enter)="commitEditDishField()"
                            (click)="$event.stopPropagation()" />
                        } @else {
                          <span class="dish-field-value">{{ item.get(fieldKey)?.value ?? '' }}</span>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>

          <button type="button" class="add-dish-btn no-print" (click)="addItem(sectionIndex)">
            + {{ 'menu_add_dish' | translatePipe }}
          </button>
        </div>
      }
    </div>

    <button type="button" class="add-section-btn no-print" (click)="addSection()">
      + {{ 'menu_add_section' | translatePipe }}
    </button>

    <div class="paper-ornament bottom"></div>
      </div>
    </div>
  </div>

  <footer class="financial-bar no-print">
    <div class="fin-metric">
      <span class="fin-label">{{ 'menu_total_cost' | translatePipe }}</span>
      <span class="fin-value">â‚ª{{ eventCost_() | number:'1.2-2' }}</span>
    </div>
    <div class="fin-metric">
      <span class="fin-label">{{ 'menu_food_cost' | translatePipe }} %</span>
      <span class="fin-value">{{ foodCostPct_() | number:'1.1-1' }}%</span>
    </div>
  </footer>
</div>
