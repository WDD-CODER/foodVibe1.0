<div class="metadata-page" dir="rtl">
  @if (isImporting_()) {
    <app-loader size="large" label="loader_cooking_up" [overlay]="true" />
  }
  <header class="header-section">
    <h1>ניהול הגדרות ליבה (The Brain)</h1>
    <p>שליטה גלובלית על יחידות מידה, אלרגנים, קטגוריות מוצרים ותוויות מתכונים</p>
  </header>

  <div class="admin-grid">
    <ng-container *ngTemplateOutlet="managerCard; context: { 
      title: 'יחידות והמרות', 
      icon: 'scale', 
      colorClass: 'text-emerald-600',
      items: allUnitKeys_(),
      type: 'unit'
    }"></ng-container>

    <ng-container *ngTemplateOutlet="managerCard; context: { 
      title: 'קטגוריות מוצרים', 
      icon: 'tag', 
      colorClass: 'text-indigo-600',
      items: allCategories_(),
      type: 'category'
    }"></ng-container>

    <ng-container *ngTemplateOutlet="managerCard; context: { 
      title: 'מאגר אלרגנים גלובלי', 
      icon: 'alert-triangle', 
      colorClass: 'text-rose-500',
      items: allAllergens_(),
      type: 'allergen'
    }"></ng-container>

    <ng-container *ngTemplateOutlet="managerCard; context: { 
      title: 'תוויות מתכונים', 
      icon: 'tags', 
      colorClass: 'text-sky-600',
      items: allLabelKeys_(),
      type: 'label'
    }"></ng-container>

    <section class="manager-card menu-types-card">
      <div class="card-title">
        <lucide-icon name="utensils-crossed" class="text-teal-600"></lucide-icon>
        <h2>סוגי תפריט (Menu Types)</h2>
      </div>
      <p class="card-desc">קביעת שדות לכל סוג תפריט (מחיר מכירה, עלות מזון, מנות וכו׳)</p>
      <button type="button" class="btn-add" (click)="onAddMenuType()">הוסף סוג תפריט</button>
      <div class="list-container">
        @if (allMenuTypes_().length > 0) {
          <div class="list-stack">
            @for (def of allMenuTypes_(); track def.key) {
              <div class="list-item group menu-type-row">
                @if (editingMenuTypeKey_() === def.key) {
                  <div class="menu-type-edit">
                    <span class="menu-type-key">{{ def.key }}</span>
                    <div class="field-checkboxes">
                      @for (f of ALL_DISH_FIELDS; track f.key) {
                        <label class="field-check">
                          <input type="checkbox" [checked]="isMenuTypeFieldSelected(f.key)" (change)="toggleMenuTypeField(f.key)">
                          {{ f.labelKey | translatePipe }}
                        </label>
                      }
                    </div>
                    <div class="edit-actions">
                      <button type="button" class="btn-save-small" (click)="onSaveMenuTypeFields()">שמור</button>
                      <button type="button" class="btn-ghost-small" (click)="onCancelEditMenuType()">ביטול</button>
                    </div>
                  </div>
                } @else {
                  <span class="menu-type-key">{{ def.key }}</span>
                  <div class="field-pills">
                    @for (f of def.fields; track f) {
                      <span class="field-pill">{{ getDishFieldLabelKey(f) | translatePipe }}</span>
                    }
                  </div>
                  <button type="button" class="btn-edit" (click)="onEditMenuType(def.key)">
                    <lucide-icon name="pencil" [size]="14"></lucide-icon>
                  </button>
                  <button type="button" class="btn-delete" (click)="onRemoveMenuType(def.key)">
                    <lucide-icon name="trash-2" [size]="16"></lucide-icon>
                  </button>
                }
              </div>
            }
          </div>
        } @else {
          <div class="empty-state">אין סוגי תפריט. לחץ "הוסף סוג תפריט".</div>
        }
      </div>
    </section>
  </div>

  <section class="demo-section manager-card">
    <div class="card-title">
      <lucide-icon name="package" class="text-amber-600"></lucide-icon>
      <h2>{{ 'load_demo_data' | translatePipe }}</h2>
    </div>
    <p class="demo-desc">נתוני הדגמה: כ-100 מוצרים, 8 ספקים, 10 הכנות ו-10 מנות. גיבוי ב-assets/data.</p>
    <button type="button" class="btn-demo" (click)="onLoadDemoData()">
      {{ 'load_demo_data' | translatePipe }}
    </button>
  </section>
</div>

<ng-template #managerCard let-title="title" let-icon="icon" let-colorClass="colorClass" let-items="items"
  let-type="type">
  <section class="manager-card">
    <div class="card-title">
      <lucide-icon [name]="icon" [class]="colorClass"></lucide-icon>
      <h2>{{ title }}</h2>
    </div>

    <div class="input-group">
      <input #newInput type="text" [placeholder]="'הוסף ' + title + '...'"
        (keyup.enter)="onAddMetadata(newInput.value, type, newInput)">

      <button (click)="onAddMetadata(newInput.value, type, newInput)" class="btn-add">
        הוסף
      </button>
    </div>

    <div class="list-container">
      @if (items.length > 0) {
      <div [class]="type === 'allergen' ? 'allergen-pool' : 'list-stack'">
        @for (item of items; track item) {
        <div [class]="type === 'allergen' ? 'allergen-pill' : 'list-item group'">
          @if (type === 'label') {
            <span class="label-color-dot" [style.background-color]="getLabelColor(item)"></span>
          }
          <span>{{ item | translatePipe }}</span>

          @if (type === 'unit') {
          <input type="number" [value]="tempUnitRates()[item]" (change)="updateUnitRate(item, $event)
          ">
          }

          <button class="btn-delete" (click)="onRemoveMetadata(item, type)">
            <lucide-icon [name]="type === 'allergen' ? 'x' : 'trash-2'"
              [size]="type === 'allergen' ? 14 : 16"></lucide-icon>
          </button>
        </div>
        }
      </div>
      } @else {
      <div class="empty-state">אין {{ title }} רשומים במערכת</div>
      }
    </div>
  </section>
</ng-template>