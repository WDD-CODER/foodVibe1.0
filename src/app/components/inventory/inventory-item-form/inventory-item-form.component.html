<div class="item-form-container">
  <h2>{{ isEditing_() ? 'Edit Item' : 'Add New Item' }}</h2>

  <form [formGroup]="itemForm" (ngSubmit)="onSubmit()">
    <div class="form-group" (clickOutside)="showItemDropdown_.set(false)">
      <label for="itemName">Item Name:</label>
      <input id="itemName" type="text" formControlName="itemName" (focus)="showItemDropdown_.set(true)">
      
      <div *ngIf="showItemDropdown_() && searchItems_().length > 0" class="autocomplete-dropdown">
        <div *ngFor="let item of searchItems_()" (click)="selectExistingItem(item)" class="dropdown-item">
          {{ item.itemName }}
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group form-group--compact" (clickOutside)="showTopCategoryDropdown_.set(false)">
        <label>Top Category:</label>
        <div class="multi-select-dropdown" (click)="showTopCategoryDropdown_.set(!showTopCategoryDropdown_())">
          <div class="selected-items">
            <span *ngIf="selectedTopCategories_().length === 0">Select...</span>
            <span *ngFor="let category of selectedTopCategories_()" class="selected-tag" (click)="toggleTopCategory(category); $event.stopPropagation()">
              {{ category }}
            </span>
          </div>
          <div *ngIf="showTopCategoryDropdown_()" class="dropdown-list">
            <div *ngFor="let cat of itemDataService.allTopCategories_()" class="dropdown-item">
              <input type="checkbox" [id]="cat" [checked]="selectedTopCategories_().includes(cat)" (change)="toggleTopCategory(cat)">
              <label [for]="cat">{{ cat }}</label>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group form-group--compact" (clickOutside)="showAllergenDropdown_.set(false)">
        <label>Allergens:</label>
        <div class="multi-select-dropdown" (click)="showAllergenDropdown_.set(!showAllergenDropdown_())">
          <div class="selected-items">
            <span *ngIf="selectedAllergens_().length === 0">Select...</span>
            <span *ngFor="let alg of selectedAllergens_()" class="selected-tag" (click)="toggleAllergen(alg); $event.stopPropagation()">
              {{ alg }}
            </span>
          </div>
          <div *ngIf="showAllergenDropdown_()" class="dropdown-list">
            <div *ngFor="let alg of itemDataService.allAllergens_()" 
                 class="dropdown-item"
                 (click)="toggleAllergen(alg); $event.stopPropagation()">
              
              <input type="checkbox" 
                     [id]="'alg-' + alg" 
                     [checked]="selectedAllergens_().includes(alg)"
                     (click)="$event.stopPropagation()"
                     (change)="toggleAllergen(alg)">
              
              <label [for]="'alg-' + alg" (click)="$event.stopPropagation()">
                {{ alg }}
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div formArrayName="properties" class="properties-section">
      <h3>Additional Properties</h3>
      <div *ngFor="let prop of properties.controls; let i = index" [formGroupName]="i" class="property-group">
        <input type="text" formControlName="key" placeholder="Key">
        <input type="text" formControlName="value" placeholder="Value">
        <button type="button" (click)="removeProperty(i)">Remove</button>
      </div>
      <button type="button" (click)="addProperty()">Add Property</button>
    </div>

    <div class="form-actions">
      <button type="submit" [disabled]="itemForm.invalid">{{ isEditing_() ? 'Update' : 'Add' }}</button>
      <button type="button" (click)="onCancel()">Cancel</button>
    </div>
  </form>
</div>